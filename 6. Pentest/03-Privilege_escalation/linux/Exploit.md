
# Exploit
An exploit (from the English verb to exploit, meaning "to use something to one’s own advantage") is a piece of software, a chunk of data, or a sequence of commands that takes advantage of a bug or vulnerability to cause unintended or unanticipated behavior to occur on computer software, hardware, or something electronic (usually computerized).[1] Such behavior frequently includes things like gaining control of a computer system, allowing privilege escalation, or a denial-of-service (DoS or related DDoS) attack.

## Service exploit
As you know, a computer has services running in the background (Samba, MySQL, Apache,...) All these services are likely to have a vulnerability. It is better to try to exploit these services first before trying to exploit a kernel vulnerability.

First of all it is necessary to know under which user the service in question is launched. It is necessary that the account that ran the service has privileges higher than those you already have.

You can see this by running the "ps" command. Another information that can be obtained is the PID of the process. 

```bash
┌──(kali㉿kali)-[~]
└─$ ps -aux | grep root  
root           1  0.0  0.2 166264 11504 ?        Ss   Jul28   0:03 /sbin/init splash
root           2  0.0  0.0      0     0 ?        S    Jul28   0:00 [kthreadd]
root           3  0.0  0.0      0     0 ?        I<   Jul28   0:00 [rcu_gp]
root           4  0.0  0.0      0     0 ?        I<   Jul28   0:00 [rcu_par_gp]
root           6  0.0  0.0      0     0 ?        I<   Jul28   0:00 [kworker/0:0H-events_highpri]
root           9  0.0  0.0      0     0 ?        I<   Jul28   0:00 [mm_percpu_wq]

...

root      4596  0.0  0.0   5396  1272 ?        Ss   Jun21   1:14 /usr/sbin/nmbd -D
root      4598  0.0  0.0   7724  1704 ?        Ss   Jun21   0:00 /usr/sbin/smbd -D
root      4603  0.0  0.0   7724   808 ?        S    Jun21   0:00 /usr/sbin/smbd -D
```
Here we can see that the samba service is running as root.

You can get the version of by doing the command ``smbd --version`` 

````bash
alice@metasploitable:~$ smbd --version
Version 3.0.20-Debian
````
Search in searchsploit with the term samba 3.0.20

````
┌──(kali㉿kali)-[~/pentest/]
└─$ searchsploit Samba 3.0.20 
---------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                    |  Path
---------------------------------------------------------------------------------- ---------------------------------
Samba 3.0.10 < 3.3.5 - Format String / Security Bypass                            | multiple/remote/10095.txt
Samba 3.0.20 < 3.0.25rc3 - 'Username' map script' Command Execution (Metasploit)  | unix/remote/16320.rb
Samba < 3.0.20 - Remote Heap Overflow                                             | linux/remote/7701.txt
Samba < 3.0.20 - Remote Heap Overflow                                             | linux/remote/7701.txt
Samba < 3.6.2 (x86) - Denial of Service (PoC)                                     | linux_x86/dos/36741.py
---------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results
````

We can see that this vulnerability (CVE-2007-2447) allows in this case to have access to the root account.

> Samba 3.0.20 < 3.0.25rc3 - 'Username' map script' Command Execution (Metasploit) 

**Countermeasures :**  
Never run a service as root unless it is really necessary, especially web, database and file servers.

---- 

**Exercise :**
- IP : 10.12.1.36
- ID : alice
- PASSWORD : alice

Connect to 10.11.1.36 with alice account.

- What is the samba version  ? 
    > Your answer
- On your kali machine, download this script : https://github.com/amriunix/CVE-2007-2447
- Execute on your kali machine with those parameters :
    - RHOST = Remote Host - Victim ip
    - RPORT = Remote Port - port of samba
    - LHOST = The local ip
    - LPORT -- The loical port

- Execute a listener on your kali machine

And BIM!

----


## Kernel Exploit
Kernel exploits are programs that exploit kernel vulnerabilities to execute arbitrary code with elevated permissions. Successful kernel exploits typically give attackers superuser access to target systems in the form of a root command prompt. In many cases, going root on a Linux system is as simple as downloading a kernel exploit onto the target file system, compiling the exploit, and then executing it.

Assuming we can execute code as an unprivileged user, this is the generic workflow of a kernel exploit.

1. Prompts the kernel to execute our payload in kernel mode
2. Manipulate kernel data, e.g. process privileges
3. Launch a shell with new Get root! privileges.

Consider that for a kernel exploitation attack to succeed, an adversary requires four conditions:

1. A vulnerable kernel
2. A matching exploit
3. The ability to transfer the exploit to the target
4. The ability to execute the exploit on the target

The easiest way to defend against kernel exploits is to keep the kernel patched and updated. In the absence of patches, administrators can strongly influence the ability to transfer and execute the exploit on the target. Given these considerations, kernel exploit attacks are no longer viable if an administrator can prevent the introduction and/or execution of the exploit on the Linux file system. Therefore, administrators should focus on restricting or removing programs that allow file transfers, such as FTP, TFTP, SCP, wget and curl. When these programs are required, their use should be restricted to specific users, directories, applications (such as SCP) and IP addresses or domains.

The infamous DirtyCow exploit - Linux Kernel <= 3.19.0-73.8

A race condition was found in the way the Linux kernel memory subsystem handled copy-on-write (COW) breakage of private read-only memory mappings. An unprivileged local user could use this flaw to gain write access to otherwise read-only memory mappings and thus increase their privileges on the system. This was one of the most serious privilege escalation vulnerabilities ever discovered and affected almost all major Linux distributions.

You can see more variants of dirtycow exploits here - https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs

There are many local privilege escalation exploits publicly available for different kernels and operating systems. The possibility of gaining root access on a Linux host using a kernel exploit depends on whether the kernel is vulnerable or not. Kali Linux has a local copy of the exploit-db exploits that make it easy to find local root exploits. Although I do not suggest relying entirely on this database when searching for Linux kernel exploits.

```
searchsploit Linux Kernel 2.6.24 - It shows us all available exploits for a particular Linux kernel that are already present in kali Linux.
```

Why should you avoid running any local privilege escalation exploit in the first place?
However, it is very tempting to simply run an exploit and gain root access, but you should always keep that as your last option.

1. The remote host may crash as many publicly available root exploits are not very stable.
2. You could become root and then crash the box.
3. The exploit may leave traces/logs that can get you caught.

You should always try the other techniques for getting root that have been discussed below before jumping straight to running a local root exploit.

**Countermeasures :**
- Keep the kernel patched and updated.

----
**Exercise :**
- IP : 10.12.1.36
- ID : alice
- PASSWORD : alice

Connect to 10.12.1.36 with alice account.

- What is the kernel version  ? 
    > `unmae -r`: 2.6.24-16-server

- Look in searchsploit if the kernel is vulnerable? If or how many are there?
    > With the KERNEL keyword, about 56.
    > `searchsploit linux 2.6.24`

- Download the dirtycow exploit from here : https://www.exploit-db.com/exploits/40839/

- Compile and execute it. It replaces the user 'root' with a new user 'rash' by editing the file /etc/passwd.


And BIM !

---- 



