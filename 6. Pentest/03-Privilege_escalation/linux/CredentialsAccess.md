
# Credentials acces

## Credentials from Bash History
Bash keeps track of the commands that users type on the command line with the "history" utility. Once a user logs out, the history is dumped into the user's .bash_historyfolder. For each user, this file resides in the same location: ~/.bash_history. Typically, this file keeps track of the user's last 500 commands. Users often enter usernames and passwords on the command line as program settings, which are then saved in this file when they log out. Adversaries can abuse this by browsing the file for potential credentials

----
**Exercise :**

- IP : 10.12.1.36
- ID : alice
- PASSWORD : alice

Connect to 10.12.1.36 with alice account.

- Search for a password that you can find in the history. What is the password?
    > msfadmin

- Do a privilege elevation by logging into that account. What is the user?
    > msfadmin

----


**Countermeasures**  
This type of attack technique cannot be easily mitigated with preventive controls since it is based on the abuse of system features.

## SSH keys
Secure Shell (SSH) is a cryptographic network protocol which allows users to securely perform a number of network services, such as remote authentication or file transfer, over an unsecured network. SSH keys provide a more secure way of logging into a server through SSH than via a password authentication.

If improperly configured, SSH keys could allow an attacker to authenticate as another user to escalate privilege, potentially even as root.


### Understanding Asymmetric Encryption
Before diving into the possible attacks, it is crucial to understand the key pair concept that SSH and other asymmetric cryptographic protocols utilize to secure a connection. These use a private key to encrypt information, and a corresponding public key to decrypt it.

When communicating to a machine via SSH, a user can authenticate if their private key is considered trustworthy by the server and added to the authorized_keys file, or if their private key corresponds to a public key stored in the server.

The default name for public keys is usually id_rsa.pub or id_dsa.pub and the default name for private keys is id_rsa or id_dsa, based on the encryption algorithm used. DSA is known to be insecure.

### Exploiting SSH Keys
The main two ways of exploiting SSH keys are the following:

1. Accessing readable private SSH keys and using them to authenticate.
2. Accessing writable public SSH keys and adding your own one to them to authenticate.

If readable private keys or writable public keys are present on the machine, this could allow for an attacker to escalate privileges to root.

Public and private keys are generally stored in one of the following locations:
````
/root/.ssh/
/home/user_name/.ssh/ (users home directory)
/etc/ssh/
````

in the paths specified in the ssh_config or sshd_config config files
The following command can be used to identify any existing public or private keys and their permissions:

````
ls -la /home /root /etc/ssh /home/*/.ssh/; locate id_rsa; locate id_dsa; find / -name id_rsa 2> /dev/null; find / -name id_dsa 2> /dev/null; find / -name authorized_keys 2> /dev/null; cat /home/*/.ssh/id_rsa; /home/*/.ssh/id_dsa
````

### Readable Private Keys
As mentioned earlier, private keys are used by users to authenticate via SSH. If a private key is stored in a way that makes it accessible to the current user, this means it can be used to perform an authentication as the owner of the private key.

Using the command mentioned earlier, the system has flagged that the private key for the "alice" user is readable to all users:

````bash
/home/alice/.ssh $ ls -la
total 20
drwxr-xr-x 2 msfadmin msfadmin 4096 2010-05-17 21:43 .
drwxr-xr-x 7 msfadmin msfadmin 4096 2022-06-17 06:25 ..
-rwxr-xr-x 1 msfadmin msfadmin  609 2010-05-07 14:38 authorized_keys
-rwxr-xr-x 1 msfadmin msfadmin 1675 2010-05-17 21:43 id_rsa
-rwxr-xr-x 1 msfadmin msfadmin  405 2010-05-17 21:43 id_rsa.pub

````

The easiest way to exploit this is to simply copy the key over to a Kali host, either by using one of the techniques shown in this article, or by simply copying and pasting the contents of the file. For the purpose of this guide I will be copying the key to a new file in Kali using Vim:

````bash
/hopme/alice/.ssh $ cat id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEoQIBAAKCAQEApmGJFZNl0ibMNALQx7M6sGGoi4KNmj6PVxpbpG70lShHQqld
JkcteZZdPFSbW76IUiPR0Oh+WBV0x1c6iPL/0zUYFHyFKAz1e6/5teoweG1jr2qO
ffdomVhvXXvSjGaSFwwOYB8R0QxsOWWTQTYSeBa66X6e777GVkHCDLYgZSo8wWr5
JXln/Tw7XotowHr8FEGvw2zW1krU3Zo9Bzp0e0ac2U+qUGIzIu/WwgztLZs5/D9I
yhtRWocyQPE+kcP+Jz2mt4y1uA73KqoXfdw5oGUkxdFo9f1nu2OwkjOc+Wv8Vw7b
wkf+1RgiOMgiJ5cCs4WocyVxsXovcNnbALTp3wIBIwKCAQBaUjR5bUXnHGA5fd8N
...
Fb3Yq4pdHm7AosAgtfC1eQi/xbXP73kloEmg39NZAfT3wg817FXiS2QGHXJ4/dmK
94Z9XOEDocClV7hr9H//hoO8fV/PHXh0oFQvw1d+29nf+sgWDg==
-----END RSA PRIVATE KEY-----
````

In order for the private key to be accepted by SSH, it needs to be only readable and writable only by its owner, otherwise it will complain that the permissions applied are too open.

Using the following command to change the file permissions against the newly created SSH private key:

````
chmod 600 key_name
````

The following command can then be used to login as the "alice" user:
````
ssh -i key_name user_name@X.X.X.X
````

Note: When access services that allow file sharing such as FTP, SMB, HTTP etc is allowed, common SSH keys directories should be checked for open private keys.

**Countermeasures**
- Do not allow reading and writing on the
files.

## Sudo Acces
If the attacker cannot directly gain root access via other techniques, he can try to compromise one of the users with SUDO access. Once he has access to one of the SUDO users, he can essentially execute any command with root privileges.

Administrators can simply allow users to execute some commands via SUDO and not all, but even with this configuration, they can unknowingly introduce vulnerabilities, which can result in elevation of privileges.

A classic example is assigning SUDO rights to the find command so that another user can search the system for particular files/logs. While the administrator may be unaware that the find command contains parameters for command execution, an attacker can execute commands with root privilege.


Exploiting misconfigured SUDO rights to gain root access
````bash
$  sudo -l 
````

We can run find, cat and python as SUDO. All these commands will run as root when executed with SUDO. If we can somehow escape the shell via one of these commands, we can gain root access.

````bash
sudo find /home -exec sh -i \;
````
The exec parameter of the find command can be used to execute arbitrary code

----
**Exercise :**
- IP : 10.12.1.36
- ID : alice
- PASSWORD : alice

Connect to 10.12.1..36 with alice account.

- What programs can we run as sudo?
    > Your answer

- [Look at the gtfobins site to see which executable would give you root privileges](https://gtfobins.github.io/)
    > Your answer

- Execute de the command.
- What is the executable run as sudo ? 
    > Your answer

And BIM ! 

----

**Countermeasures**

Do not give sudo rights to a program that allows you to escape to the shell.
Never give sudo rights to vi, more, less, nmap, perl, ruby, python, gdb and others.

## Group Privilege

In Linux, groups are an attribute that can be allocated to users to allow them to access certain files/binaries or perform certain actions in the operating system.

Some groups, when assigned to a given user, can allow them to perform actions that go beyond their usual privileges and potentially escalate privileges to root.

### Identifying User Groups

In order to identify the groups the current user belongs to, the following command can be used:

````
id -Gn
````

Alternatively, the groups command will obtain the same result:
````
groups
````


### Exploitable groups

The following groups can be exploited in some shape or form to perform restricted actions:

````
root
sudo/admin/wheel
video
disk
shadow
adm
docker
LXC/LXD
````

### Root
The root group doesn’t serve any specific purpose, it simply gives users access to root group files and binaries, which don’t fall under any specific categories.

There are many ways to exploit this vulnerability, such as modifying the /etc/passwd file, adding new root SSH keys, viewing and cracking system passwords and more.

### Sudo/Admin & Wheel
The sudo/admin (in Debian derivatives) or wheel (in CentOS/RedHat derivatives) group is a special user group used to control access to the su or sudo commands, which allow users to either execute commands or masquerade as another user (usually the super user).

### Video
The video group can be used locally to give a set of users access to a video device or to the screen output.

This could be exploited by taking a screenshot of the current screen output and gathering any private information such as user passwords or hashes.

The following commands can be used to grab the raw output of the current screen and gather the current resolution settings (height and width):

````
cp /dev/fb0 /tmp/fb0.raw
width=$(cat /sys/class/graphics/fb0/virtual_size | cut -d, -f1)
height=$(cat /sys/class/graphics/fb0/virtual_size | cut -d, -f2)
````

The following perl script can then be used to convert the .raw file to an actual image 

````
#!/usr/bin/perl -w

$w = shift || 240;
$h = shift || 320;
$pixels = $w * $h;

open OUT, "|pnmtopng" or die "Can't pipe pnmtopng: $!\n";

printf OUT "P6%d %d\n255\n", $w, $h;

while ((read STDIN, $raw, 2) and $pixels--) {
   $short = unpack('S', $raw);
   print OUT pack("C3",
      ($short & 0xf800) >> 8,
      ($short & 0x7e0) >> 3,
      ($short & 0x1f) << 3);
}

close OUT;
````

### Shadow
The shadow group is required for the Linux shadow functionality to work, which is used to administer user passwords.

It is supposed to be accessible by the root user only, but because multiple users may be in the root group, the shadow group was created.

Since users in this group have access to view the /etc/shadow file, this can be exploited by cracking password hashes found in it.

### Disk
The disk group provides users with access to the raw data contained in disks and partitions.

### Docker
Docker is a platform that uses OS-level virtualization to manage applications in packages called containers.

The docker group is used to grant users access to manage, create, edit or delete docker containers.

To exploit this, the existing file system can be mounted as a container, allowing users that are part of the docker group to edit any files within the file system, for example the /etc/passwd file. 

### LXC/LXD
The LXC/LXD groups are used to allow users to create and manage Linux containers. These can be exploited by creating a root-level privilege container and interacting with it, executing bash and therefore starting a root shell.
